<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π - SVPAY</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <script>
        // Fallback –µ—Å–ª–∏ XLSX –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Å CDN
        if (typeof XLSX === 'undefined') {
            console.warn('XLSX –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –ø—ã—Ç–∞–µ–º—Å—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫');
            var script = document.createElement('script');
            script.src = 'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js';
            document.head.appendChild(script);
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        h1 {
            color: #1e293b;
            font-weight: 700;
            font-size: 28px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .user-badge {
            background: #f1f5f9;
            color: #475569;
            padding: 8px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
        }

        .nav-btn-primary {
            background: #2563eb;
            color: white;
        }

        .nav-btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .controls {
            background: white;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        input[type="text"], input[type="date"], select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            background: #f8fafc;
            color: #1e293b;
            transition: all 0.2s ease;
        }

        input[type="text"]:focus, input[type="date"]:focus, select:focus {
            outline: none;
            border-color: #2563eb;
            background: white;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.08);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

        .table-wrapper {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            font-size: 14px;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            color: #1e293b;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        .transaction-type {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .type-add {
            background: #dcfce7;
            color: #166534;
        }

        .type-use {
            background: #fee2e2;
            color: #991b1b;
        }

        .type-initial {
            background: #dbeafe;
            color: #1e40af;
        }

        .type-manual {
            background: #f3e8ff;
            color: #6b21a8;
        }

        .amount {
            font-weight: 600;
        }

        .amount-positive {
            color: #059669;
        }

        .amount-negative {
            color: #dc2626;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }

        .empty-state h2 {
            color: #1e293b;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .empty-state p {
            color: #64748b;
            font-size: 15px;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            color: #64748b;
            font-size: 16px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
            border-left: 4px solid #2563eb;
        }

        .stat-label {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .reset-btn {
            background: #ef4444;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .reset-btn:hover {
            background: #dc2626;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .pagination button, .pagination span {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            color: #475569;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: #f1f5f9;
            border-color: #cbd5e1;
            transform: translateY(-1px);
        }

        .pagination button.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .pagination button.active:hover {
            background: #1d4ed8;
            border-color: #1d4ed8;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-info {
            text-align: center;
            color: #64748b;
            font-size: 14px;
            margin-top: 12px;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }

            .controls {
                flex-direction: column;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .table-wrapper {
                padding: 16px;
            }

            th, td {
                padding: 12px 8px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h1>
            <div class="header-actions">
                <span class="user-badge" id="userBadge">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                <div class="nav-buttons">
                    <a href="/" class="nav-btn nav-btn-primary">‚Üê –ö–∞—Ä—Ç—ã</a>
                </div>
                <button class="logout-btn" onclick="logout()">–í—ã—Ö–æ–¥</button>
            </div>
        </header>

        <div class="stats" id="statsContainer">
            <div class="stat-card">
                <div class="stat-label">–í—Å–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div>
                <div class="stat-value" id="totalTransactions">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–í—Å–µ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ —Å—Ç–∏—Ä–æ–∫</div>
                <div class="stat-value" id="totalAdded" style="color: #059669;">+0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–í—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Å—Ç–∏—Ä–æ–∫</div>
                <div class="stat-value" id="totalUsed" style="color: #dc2626;">-0</div>
            </div>
        </div>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∫–∞—Ä—Ç—ã...">
            </div>
            <div style="min-width: 150px;">
                <input type="date" id="dateFrom" />
            </div>
            <div style="min-width: 150px;">
                <input type="date" id="dateTo" />
            </div>
            <select id="typeFilter">
                <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                <option value="add_balance">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</option>
                <option value="use">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ</option>
                <option value="initial">–°–æ–∑–¥–∞–Ω–∏–µ</option>
                <option value="manual_update">–†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</option>
            </select>
            <button class="btn btn-secondary" onclick="resetFilters()">–°–±—Ä–æ—Å–∏—Ç—å</button>
            <button class="btn btn-success" onclick="exportToExcel()">üì• Excel</button>
            <button class="btn btn-success" onclick="exportToCSV()">üì• CSV</button>
        </div>

        <div id="tableContainer" class="table-wrapper">
            <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>

        <div id="paginationContainer" style="margin-top: 24px;"></div>
    </div>

    <script>
        let allTransactions = [];
        let currentPage = 1;
        const itemsPerPage = 50;

        function getToken() {
            return localStorage.getItem('svpay_token') || sessionStorage.getItem('svpay_token');
        }

        function getAuthHeaders() {
            const token = getToken();
            if (!token) {
                logout();
                return null;
            }
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        async function fetchWithAuth(url, options = {}) {
            const headers = getAuthHeaders();
            if (!headers) {
                return new Promise((_, reject) => reject(new Error("No token")));
            }
            
            options.headers = { ...headers, ...options.headers };

            try {
                const response = await fetch(url, options);
                
                if (response.status === 401) {
                    alert("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
                    logout();
                    throw new Error("Unauthorized");
                }
                
                return response;
                
            } catch (error) {
                throw error;
            }
        }

        async function checkAuth() {
            const token = getToken();
            if (!token) {
                window.location.href = '/login';
                return false;
            }

            try {
                const response = await fetchWithAuth('/api/users/me');
                if (!response.ok) throw new Error("Failed to fetch user");
                
                const user = await response.json();
                document.getElementById('userBadge').textContent = escapeHtml(user.username);
                return true;
            } catch (error) {
                console.error("Auth check failed:", error);
                return false;
            }
        }

        function logout() {
            localStorage.removeItem('svpay_token');
            sessionStorage.removeItem('svpay_token');
            window.location.href = '/login';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) return;

            loadTransactions();

            // Event listeners for filters
            document.getElementById('searchInput').addEventListener('input', filterTransactions);
            document.getElementById('dateFrom').addEventListener('change', filterTransactions);
            document.getElementById('dateTo').addEventListener('change', filterTransactions);
            document.getElementById('typeFilter').addEventListener('change', filterTransactions);
        });

        async function loadTransactions() {
            try {
                const response = await fetchWithAuth('/api/transactions/all?limit=all');
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.statusText}`);
                }
                
                const transactions = await response.json();
                
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞—Ä—Ç–∞—Ö –¥–ª—è –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                const cardsResponse = await fetchWithAuth('/api/cards');
                const cards = await cardsResponse.json();
                
                // –°–æ–∑–¥–∞–µ–º map –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
                const cardsMap = {};
                cards.forEach(card => {
                    cardsMap[card.id] = card.name;
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è –∫–∞—Ä—Ç—ã –∫ –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                allTransactions = transactions.map(t => ({
                    ...t,
                    card_name: cardsMap[t.card_id] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
                }));
                
                filterTransactions();
            } catch (error) {
                if (error.message === "Unauthorized") return;
                console.error('Error loading transactions:', error);
                document.getElementById('tableContainer').innerHTML = `
                    <div class="empty-state">
                        <h2>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h2>
                        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É.</p>
                    </div>
                `;
            }
        }

        function filterTransactions() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const typeFilter = document.getElementById('typeFilter').value;

            let filtered = allTransactions.filter(t => {
                const matchesSearch = t.card_name.toLowerCase().includes(searchTerm);
                
                const transactionDate = t.timestamp.split('T')[0];
                const matchesDateFrom = !dateFrom || transactionDate >= dateFrom;
                const matchesDateTo = !dateTo || transactionDate <= dateTo;
                
                const matchesType = !typeFilter || t.transaction_type === typeFilter;
                
                return matchesSearch && matchesDateFrom && matchesDateTo && matchesType;
            });

            currentPage = 1; // –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            renderPaginatedTransactions(filtered);
            updateStats(filtered);
        }

        function renderTransactions(transactions) {
            const container = document.getElementById('tableContainer');
            
            if (transactions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h2>
                        <p>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏.</p>
                    </div>
                `;
                document.getElementById('paginationContainer').innerHTML = '';
                return;
            }
            
            const tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                            <th>–ö–∞—Ä—Ç–∞</th>
                            <th>–¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</th>
                            <th>–°—É–º–º–∞ (—Å—Ç–∏—Ä–æ–∫)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactions.map(t => `
                            <tr>
                                <td>${formatDateTime(t.timestamp)}</td>
                                <td>${escapeHtml(t.card_name)}</td>
                                <td>
                                    <span class="transaction-type ${getTypeClass(t.transaction_type)}">
                                        ${getTypeLabel(t.transaction_type)}
                                    </span>
                                </td>
                                <td>
                                    <span class="amount ${t.amount > 0 ? 'amount-positive' : t.amount < 0 ? 'amount-negative' : ''}">
                                        ${t.amount > 0 ? '+' : ''}${t.amount}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = tableHtml;
        }

        function renderPaginatedTransactions(transactions) {
            const totalPages = Math.ceil(transactions.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedTransactions = transactions.slice(startIndex, endIndex);

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã
            renderTransactions(paginatedTransactions);

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
            if (totalPages > 1) {
                renderPagination(totalPages, transactions.length);
            } else {
                document.getElementById('paginationContainer').innerHTML = '';
            }
        }

        function renderPagination(totalPages, totalItems) {
            const container = document.getElementById('paginationContainer');
            let html = '<div class="pagination" id="paginationButtons">';

            // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–µ–¥—ã–¥—É—â–∞—è"
            if (currentPage === 1) {
                html += '<button disabled class="pagination-btn">‚Üê –ù–∞–∑–∞–¥</button>';
            } else {
                html += `<button class="pagination-btn" data-page="${currentPage - 1}">‚Üê –ù–∞–∑–∞–¥</button>`;
            }

            // –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

            if (endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            if (startPage > 1) {
                html += '<button class="pagination-btn" data-page="1">1</button>';
                if (startPage > 2) {
                    html += '<span>...</span>';
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    html += `<button class="pagination-btn active" data-page="${i}">${i}</button>`;
                } else {
                    html += `<button class="pagination-btn" data-page="${i}">${i}</button>`;
                }
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += '<span>...</span>';
                }
                html += `<button class="pagination-btn" data-page="${totalPages}">${totalPages}</button>`;
            }

            // –ö–Ω–æ–ø–∫–∞ "–°–ª–µ–¥—É—é—â–∞—è"
            if (currentPage === totalPages) {
                html += '<button disabled class="pagination-btn">–î–∞–ª–µ–µ ‚Üí</button>';
            } else {
                html += `<button class="pagination-btn" data-page="${currentPage + 1}">–î–∞–ª–µ–µ ‚Üí</button>`;
            }

            html += '</div>';
            
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);
            html += `<div class="pagination-info">–ü–æ–∫–∞–∑–∞–Ω–æ ${startItem}-${endItem} –∏–∑ ${totalItems} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage}/${totalPages})</div>`;

            container.innerHTML = html;

            // –î–æ–±–∞–≤–ª—è–µ–º event listeners –∫ –∫–Ω–æ–ø–∫–∞–º
            document.querySelectorAll('.pagination-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const page = parseInt(this.getAttribute('data-page'));
                    if (page) {
                        goToPage(page);
                    }
                });
            });
        }

        function goToPage(page) {
            currentPage = page;
            filterTransactions();
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ
            document.getElementById('tableContainer').scrollIntoView({ behavior: 'smooth' });
        }

        function updateStats(transactions) {
            const total = transactions.length;
            const totalAdded = transactions
                .filter(t => t.amount > 0)
                .reduce((sum, t) => sum + t.amount, 0);
            const totalUsed = Math.abs(transactions
                .filter(t => t.amount < 0)
                .reduce((sum, t) => sum + t.amount, 0));
            
            document.getElementById('totalTransactions').textContent = total;
            document.getElementById('totalAdded').textContent = `+${totalAdded}`;
            document.getElementById('totalUsed').textContent = `-${totalUsed}`;
        }

        function getTypeClass(type) {
            const types = {
                'add_balance': 'type-add',
                'use': 'type-use',
                'initial': 'type-initial',
                'manual_update': 'type-manual'
            };
            return types[type] || '';
        }

        function getTypeLabel(type) {
            const labels = {
                'add_balance': '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ',
                'use': '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ',
                'initial': '–°–æ–∑–¥–∞–Ω–∏–µ',
                'manual_update': '–†—É—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ'
            };
            return labels[type] || type;
        }

        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('typeFilter').value = '';
            filterTransactions();
        }

        function exportToCSV() {
            try {
                if (allTransactions.length === 0) {
                    alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                    return;
                }

                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;
                const typeFilter = document.getElementById('typeFilter').value;

                let filtered = allTransactions.filter(t => {
                    const matchesSearch = t.card_name.toLowerCase().includes(searchTerm);
                    
                    const transactionDate = t.timestamp.split('T')[0];
                    const matchesDateFrom = !dateFrom || transactionDate >= dateFrom;
                    const matchesDateTo = !dateTo || transactionDate <= dateTo;
                    
                    const matchesType = !typeFilter || t.transaction_type === typeFilter;
                    
                    return matchesSearch && matchesDateFrom && matchesDateTo && matchesType;
                });

                if (filtered.length === 0) {
                    alert('–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ —Å –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏');
                    return;
                }

                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º CSV –¥–∞–Ω–Ω—ã–µ
                let csvContent = 'data:text/csv;charset=utf-8,';
                csvContent += '–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è,–ö–∞—Ä—Ç–∞,–¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏,–°—É–º–º–∞ (—Å—Ç–∏—Ä–æ–∫)\n';
                
                filtered.forEach(t => {
                    const dateTime = formatDateTime(t.timestamp);
                    const cardName = t.card_name.replace(/,/g, ';'); // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∑–∞–ø—è—Ç—ã–µ
                    const typeLabel = getTypeLabel(t.transaction_type);
                    const amount = (t.amount > 0 ? '+' : '') + t.amount;
                    
                    csvContent += `"${dateTime}","${cardName}","${typeLabel}","${amount}"\n`;
                });

                // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `svpay_history_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                
                // –ö–ª–∏–∫–∞–µ–º –ø–æ —Å—Å—ã–ª–∫–µ –∏ —É–¥–∞–ª—è–µ–º –µ—ë
                link.click();
                document.body.removeChild(link);
                
                alert(`CSV —Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω (${filtered.length} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)`);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ CSV:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: ' + error.message);
            }
        }
        
        function exportToExcel() {
            try {
                if (allTransactions.length === 0) {
                    alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                    return;
                }

                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const dateFrom = document.getElementById('dateFrom').value;
                const dateTo = document.getElementById('dateTo').value;
                const typeFilter = document.getElementById('typeFilter').value;

                let filtered = allTransactions.filter(t => {
                    const matchesSearch = t.card_name.toLowerCase().includes(searchTerm);
                    
                    const transactionDate = t.timestamp.split('T')[0];
                    const matchesDateFrom = !dateFrom || transactionDate >= dateFrom;
                    const matchesDateTo = !dateTo || transactionDate <= dateTo;
                    
                    const matchesType = !typeFilter || t.transaction_type === typeFilter;
                    
                    return matchesSearch && matchesDateFrom && matchesDateTo && matchesType;
                });

                if (filtered.length === 0) {
                    alert('–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ —Å –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏');
                    return;
                }

                console.log('–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º', filtered.length, '—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π');

                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Excel
                const excelData = [];
                excelData.push(['–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è', '–ö–∞—Ä—Ç–∞', '–¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏', '–°—É–º–º–∞ (—Å—Ç–∏—Ä–æ–∫)']);
                
                filtered.forEach(t => {
                    excelData.push([
                        formatDateTime(t.timestamp),
                        t.card_name,
                        getTypeLabel(t.transaction_type),
                        (t.amount > 0 ? '+' : '') + t.amount
                    ]);
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å XLSX
                if (typeof XLSX === 'undefined') {
                    alert('–û—à–∏–±–∫–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Excel –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                    console.error('XLSX –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞');
                    return;
                }

                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–Ω–∏–≥—É Excel
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "–ò—Å—Ç–æ—Ä–∏—è");

                // –£—Å—Ç–∞–Ω–æ–≤–∏–º —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
                ws['!cols'] = [
                    { wch: 20 },  // –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è
                    { wch: 30 },  // –ö–∞—Ä—Ç–∞
                    { wch: 20 },  // –¢–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                    { wch: 15 }   // –°—É–º–º–∞
                ];

                // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                const fileName = `svpay_history_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                console.log('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω:', fileName);
                alert(`–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω: ${fileName}`);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: ' + error.message);
            }
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
